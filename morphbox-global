#!/bin/bash
set -euo pipefail

# Global MorphBox launcher for Docker-based setup
MORPHBOX_VERSION="2.0.0"
MORPHBOX_HOME="${MORPHBOX_HOME:-$HOME/.morphbox}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# First time setup
setup_morphbox() {
    info "Setting up MorphBox for the first time..."
    
    # Clone the repository
    if [[ ! -d "$MORPHBOX_HOME" ]]; then
        info "Cloning MorphBox repository..."
        git clone https://github.com/MicahBly/morphbox.git "$MORPHBOX_HOME" || \
            error "Failed to clone MorphBox repository"
    fi
    
    # Check out the docker-container branch
    cd "$MORPHBOX_HOME"
    git checkout docker-container 2>/dev/null || git checkout main
    
    # Pull latest changes
    git pull origin $(git branch --show-current) 2>/dev/null || true
    
    info "MorphBox setup complete!"
}

# Check if MorphBox is installed
if [[ ! -d "$MORPHBOX_HOME" ]] || [[ ! -f "$MORPHBOX_HOME/morphbox-start" ]]; then
    setup_morphbox
fi

# Check for Docker
if ! command -v docker >/dev/null 2>&1; then
    error "Docker is not installed. Please install Docker first: https://docs.docker.com/get-docker/"
fi

# Run morphbox-start from the installation directory
cd "$MORPHBOX_HOME"
exec ./morphbox-start "$@"