#!/bin/bash
set -euo pipefail

# MorphBox Launcher - Simplified version

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
WEB_DIR="$SCRIPT_DIR/web"

# Check dependencies
if ! command -v node > /dev/null; then
    error "Node.js is not installed. Please install Node.js 18 or later"
fi

# Install dependencies if needed
if [[ ! -d "$WEB_DIR/node_modules" ]]; then
    info "Installing dependencies..."
    cd "$WEB_DIR" && npm install
fi

# Kill any existing processes
pkill -f "tsx.*websocket-server" 2>/dev/null || true
pkill -f "vite dev" 2>/dev/null || true

# Start WebSocket server
info "Starting WebSocket server on ws://localhost:8009..."
cd "$WEB_DIR"
npm run dev:ws > "$SCRIPT_DIR/websocket.log" 2>&1 &
WS_PID=$!

# Wait for WebSocket server
sleep 2

# Start SvelteKit dev server
info "Starting MorphBox web interface..."
npm run dev > "$SCRIPT_DIR/web.log" 2>&1 &
WEB_PID=$!

# Wait for web server
sleep 3

info "MorphBox is running!"
info "- Web interface: http://localhost:8008"
info "- WebSocket server: ws://localhost:8009"
info ""
info "Press Ctrl+C to stop all services"

# Cleanup function
cleanup() {
    echo ""
    info "Stopping MorphBox..."
    kill $WS_PID 2>/dev/null || true
    kill $WEB_PID 2>/dev/null || true
    pkill -f "tsx.*websocket-server" 2>/dev/null || true
    pkill -f "vite dev" 2>/dev/null || true
    info "MorphBox stopped"
    exit 0
}

# Set up signal handler
trap cleanup SIGINT SIGTERM

# Wait for processes
wait