#!/bin/bash
set -euo pipefail

# MorphBox VM Launcher

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
WEB_DIR="$SCRIPT_DIR/web"
VM_NAME="morphbox"

# Check if Lima is installed
if ! command -v limactl > /dev/null; then
    error "Lima is not installed. Please run install.sh first"
fi

# Check if VM exists
if ! limactl list | grep -q "^${VM_NAME}"; then
    info "Creating MorphBox VM..."
    limactl create --name="${VM_NAME}" "$SCRIPT_DIR/claude-vm.yaml" || error "Failed to create VM"
fi

# Check VM status
VM_STATUS=$(limactl list "${VM_NAME}" -f '{{.Status}}')

if [[ "$VM_STATUS" != "Running" ]]; then
    info "Starting MorphBox VM..."
    limactl start "${VM_NAME}" || error "Failed to start VM"
    
    # Wait for VM to be ready
    info "Waiting for VM to be ready..."
    for i in {1..30}; do
        if limactl shell "${VM_NAME}" true 2>/dev/null; then
            break
        fi
        sleep 2
    done
fi

# Get VM SSH info
VM_SSH_PORT=$(limactl list "${VM_NAME}" -f '{{.SSHLocalPort}}')
VM_SSH_HOST="127.0.0.1"

info "VM is running on port ${VM_SSH_PORT}"

# Install MCP server in VM if not already installed
info "Checking MCP server in VM..."
limactl shell "${VM_NAME}" bash -c "
    if ! command -v mcp-server > /dev/null; then
        echo 'Installing MCP server...'
        npm install -g @modelcontextprotocol/server-cli
    fi
"

# Start MCP server in VM
info "Starting MCP server in VM..."
limactl shell "${VM_NAME}" bash -c "
    pkill -f mcp-server || true
    cd /workspace
    nohup mcp-server --port 3000 > /tmp/mcp.log 2>&1 &
    echo 'MCP server started on port 3000'
"

# Update morphbox-start to use VM connection
info "Configuring web interface to connect to VM..."

# Create environment file with VM connection info
cat > "$WEB_DIR/.env.local" << EOF
# MorphBox VM Connection
MORPHBOX_VM_HOST=${VM_SSH_HOST}
MORPHBOX_VM_PORT=${VM_SSH_PORT}
MORPHBOX_VM_USER=morphbox
MORPHBOX_MCP_URL=http://localhost:3000
EOF

# Now start the web interface
exec "$SCRIPT_DIR/morphbox-start" "$@"